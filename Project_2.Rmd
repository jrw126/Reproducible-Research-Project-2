---
title: "Reproducible Research Project 2"
author: "John Wright"
date: "Tuesday, July 22, 2014"
output: html_document
---

# Synopsis
The purpose of this anlaysis is to address the following questions:
*Across the United States, which types of events (as indicated in the `EVTYPE` variable) are most harmful with respect to population health?
*Across the United States, which types of events have the greatest economic consequences?

# Data Processing

Step 1. Download the data into your working directory and load it into R.
```{r, echo=FALSE, cache=TRUE}
dir <- getwd()
url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
download.file(url = url, destfile = file.path(dir, "stormdata.csv"))
data <- read.csv(file.path(dir, "stormdata.csv"), header = TRUE)
```

Step 2. Review the documentation and research the data source. The raw variables are constructed/defined can be found in the [National Weather Service Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) and the [National Climatic Data Center Storm Events FAW](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf). The data set goes back to 1950. According to the [NOAA website](http://www.ncdc.noaa.gov/stormevents/details.jsp), from 1950 to 1954 only tornado events were recorded and from 1955 to 1995 only tornado, thunderstorm wind and hail events were recorded. All 48 Event types from [NWS Directive 10-1605](http://www.ncdc.noaa.gov/stormevents/pd01016005curr.pdf) weren't recorded until January of 1996. The NOAA switched from unformatted text files to more modern data storage methods at the same time. For these reasons, any record with a `BGN_DATE` before January 1, 1996 has been excluded.
```{r, echo=TRUE}
data$BGN_DATE <- as.Date(as.character(data$BGN_DATE), format = "%m/%d/%Y")
data <- subset(data, BGN_DATE > as.Date("1996-01-01"))
```

Step 3. The `EVTYPE` variable has many levels, however quite a few of them are clearly duplicates or, for the purposes of this project, should be consolidated. For example:
```{r, echo=TRUE}
unique(grep("HEAVY RAIN", data$EVTYPE, value = TRUE))
```

The following steps were taken to clean and standardize the `EVTYPE` variable down to the official 48 event types:
```{r, echo=TRUE}
library(stringr)
data$EVTYPE <- str_trim(toupper(as.character(data$EVTYPE)))       # Convert EVTYPE to character class, upper case, and remove leading and trailing spaces.
data$EVTYPE <- gsub("/|-", " ", data$EVTYPE)                      # Replace "/" and "-" characters with spaces.
data$EVTYPE <- gsub("& |\\.|\\(|\\)|,|[0-9]", "", data$EVTYPE)    # Remove all non alphabetical characters.
data <- data[!grepl("SUMMARY", data$EVTYPE), ]                    # Remove any "SUMMARY..." event types. These records have lots of missing data and 
                                                                  # events that they refer to should be represented in other records.
data$EVTYPE <- str_trim(gsub(" G$|  ", "", data$EVTYPE))          # Remove trailing "G" or duplicated whitespace caused by earlier cleaning steps.
abbrv <- c("TSTM", "CSTL", "SML", "FLD", "FLDG", "WND")           # Create a vector of the abbreviations used in the remaining event types.
long <- c("THUNDERSTORM", "COASTAL", "SMALL",                     # Create a vector of the long version of the abbreviation.
          "FLOOD", "FLOOD", "WIND")   
for (i in 1:length(abbrv)) {                                      # Replace all abbreviations with their longer version.
      data$EVTYPE <- gsub(abbrv[i], long[i], data$EVTYPE)
}

NWStypes <- c("ASTRONOMICAL LOW TIDE",                            # Store a vector of all 48 official types of event.
              "AVALANCHE",                                        # The list can be found in this document: 
              "BLIZZARD",                                         # http://www.ncdc.noaa.gov/stormevents/pd01016005curr.pdf
              "COASTAL FLOOD",
              "COLD WIND CHILL",
              "DEBRIS FLOW",
              "DENSE FOG",
              "DENSE SMOKE",
              "DROUGHT",
              "DUST DEVIL",
              "DUST STORM",
              "EXCESSIVE HEAT",
              "EXTREME COLD WIND CHILL",
              "FLASH FLOOD",
              "FLOOD",
              "FREEZING FOG",
              "FROST FREEZE",
              "FUNNEL CLOUD",
              "HAIL",
              "HEAT",
              "HEAVY RAIN",
              "HEAVY SNOW",
              "HIGH SURF",
              "HIGH WIND",
              "HURRICANE TYPHOON",
              "ICE STORM",
              "LAKESHORE FLOOD",
              "LAKE EFFECT SNOW",
              "LIGHTNING",
              "MARINE HAIL",
              "MARINE HIGH WIND",
              "MARINE STRONG WIND",
              "MARINE THUNDERSTORM WIND",
              "RIP CURRENT",
              "SEICHE",
              "SLEET",
              "STORM TIDE",
              "STRONG WIND",
              "THUNDERSTORM WIND",
              "TORNADO",
              "TROPICAL DEPRESSION",
              "TROPICAL STORM",
              "TSUNAMI",
              "VOLCANIC ASH",
              "WATERSPOUT",
              "WILDFIRE",
              "WINTER STORM",
              "WINTER WEATHER")

```

Step 3. Check for columns with NA values.
```{r, echo=TRUE}
missingCols <- sapply(1:ncol(data), FUN = function(x) sum(is.na(data[, x])))
data.frame(Column = colnames(data)[missingCols > 0], NAs = missingCols[missingCols > 0])
```


